---
title: "Loan Payback Prediction"
author: "Göktürk Çolak"
date: "2025-11-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Upload and Preprocessing

```{r}
# libraries
library(tidyverse)

# setting up the directory
setwd("C:/Users/Göktürk/Desktop/Github/kaggle-playground-series/Season 5 Episode 11")

# uploading the files
train <- read_csv("data/train.csv")
test <- read_csv("data/test.csv")
sample_submission <- read_csv("data/sample_submission.csv")

train <- train %>% 
  mutate(loan_paid_back = as.factor(loan_paid_back)) 

levels(train$loan_paid_back)
```

# Exploratory Data Analysis

```{r}
train %>% 
  ggplot( aes(x = credit_score, fill = loan_paid_back)) +
  geom_density(alpha = 0.5) +
  labs(title = "Credit Score Distribution by Payback Status")


train %>% 
  ggplot(aes(x = employment_status, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Employment Status", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


train %>% 
  ggplot(aes(x = credit_score, fill = loan_paid_back)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~employment_status) +
  labs(title = "Credit Score Distribution by Employment Status and Payback")



# Note: Omit outliers since IQR is low (0.084) - DONE
# summary(train$debt_to_income_ratio)
Q1 <- quantile(train$debt_to_income_ratio, 0.25)
Q3 <- quantile(train$debt_to_income_ratio, 0.75)
IQR_value <- IQR(train$debt_to_income_ratio)

lower_bound <- Q1 - 1.5 * IQR_value
upper_bound <- Q3 + 1.5 * IQR_value

# Filter out outliers
train_clean <- train %>%
  filter(debt_to_income_ratio >= lower_bound & debt_to_income_ratio <= upper_bound)


train_clean %>% 
  ggplot(aes(x = debt_to_income_ratio, fill = loan_paid_back)) +
  geom_density(alpha = 0.3) +
  labs(title = "Debt-to-Income Ratio by Payback Status (Outliers Removed)")


# ? Not sure, model may catch some signals
train %>% 
  ggplot(aes(x = loan_purpose, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Loan Purpose", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# A1:B5 ~ Safe
# C1:C5 ~ Moderate
# D1:F5 ~ Dangerous
train %>% 
  ggplot(aes(x = grade_subgrade, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Loan Grade/Subgrade", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# corrplot ---------------------------------------------------------------------
library(corrplot)

numerical_vars <- train %>% 
  select(annual_income, debt_to_income_ratio, credit_score, loan_amount, interest_rate, loan_paid_back) %>%
  mutate(loan_paid_back = as.numeric(as.character(loan_paid_back)))

cor_matrix <- cor(numerical_vars, use = "complete.obs")

corrplot(cor_matrix, method = "color", type = "upper")

# corrplot ends ----------------------------------------------------------------


  


```

--------------------------------------------------------------------------------

EDAs tested: 
1 - loan amount X interest rate = no
2 - interest X target = no
3 - gender X target = no
4 - education X target = no

--------------------------------------------------------------------------------

# Feature Engineering

```{r}
# 1. Credit Score Binning - Done
train <- train %>%
  mutate(credit_risk_tier = case_when(credit_score <= 650 ~ "High_Risk",
                                      credit_score > 650 & credit_score < 700 ~ "Medium_Risk", 
                                      credit_score >= 700 ~ "Low_Risk")
         )

# 2. Employment Stability - ?
train <- train %>%
  mutate(employment_stability = case_when(employment_status %in% c("Employed", "Retired", "Self-employed") ~ "Stable",
                                          employment_status == "Student" ~ "Moderate", 
                                          employment_status == "Unemployed" ~ "Unstable"))

# 3. High-Risk Combination - ?
train <- train %>%
  mutate(high_risk_combination = ifelse(employment_status %in% c("Retired", "Student") & credit_score <= 650, 1, 0))

# Target encoding for employment (if you have enough data) - ? (get it explained by Gemini/Deepseek)
employment_payback_rate <- train %>%
  group_by(employment_status) %>%
  summarise(emp_payback_rate = mean(as.numeric(as.character(loan_paid_back))))

train <- train %>% left_join(employment_payback_rate, by = "employment_status")


# 4. Subgrade Classification
train <- train %>%
  mutate(grade_subgrade = factor(grade_subgrade, levels = c(paste0("A", 1:5), paste0("B", 1:5),
                                                            paste0("C", 1:5), paste0("D", 1:5),
                                                            paste0("E", 1:5), paste0("F", 1:5)),
                                 ordered = TRUE),
         loan_risk_tier = case_when(grade_subgrade %in% c(paste0("A", 1:5), paste0("B", 1:5)) ~ "Safe",
                                    grade_subgrade %in% paste0("C", 1:5) ~ "Moderate",
                                    TRUE ~ "Dangerous")
         )
```

# Feature Plots

```{r}
# Check separation between risk tiers
ggplot(train, aes(x = credit_risk_tier, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Credit Risk Tier", 
       y = "Proportion", x = "Credit Risk Tier") +
  scale_fill_manual(values = c("red", "green"))



# Compare original vs engineered feature
p1 <- ggplot(train, aes(x = employment_status, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Original Employment Status", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p2 <- ggplot(train, aes(x = employment_stability, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Engineered Employment Stability", y = "Proportion")

library(patchwork)
p1 + p2  # Side-by-side comparison


# Show the power of this flag
ggplot(train, aes(x = factor(high_risk_combination), fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by High-Risk Combination Flag",
       x = "High Risk Combination (Unemployed + Poor Credit)",
       y = "Proportion") +
  scale_x_discrete(labels = c("No", "Yes"))


# Show continuous relationship
ggplot(train, aes(x = emp_payback_rate, fill = loan_paid_back)) +
  geom_density(alpha = 0.7) +
  labs(title = "Distribution of Employment Payback Rate by Actual Outcome",
       x = "Employment Group Payback Rate",
       y = "Density") +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red")

```

# Combined Plots

```{r}
# Create a validation grid
library(patchwork)

plot1 <- ggplot(train, aes(x = credit_risk_tier, fill = loan_paid_back)) +
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45))

plot2 <- ggplot(train, aes(x = employment_stability, fill = loan_paid_back)) +
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45))

plot3 <- ggplot(train, aes(x = factor(high_risk_combination), fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(x = "High Risk Flag")

plot4 <- ggplot(train, aes(x = emp_payback_rate, color = loan_paid_back)) +
  geom_density() + 
  labs(x = "Emp Payback Rate")

(plot1 + plot2) / (plot3 + plot4) +
  plot_annotation(title = "Feature Engineering Validation")
```

# Final Feature Engineering & Modelling & Submission File

```{r}
# Load libraries
library(caret)

# Apply the SAME feature engineering from above to create modeling dataset
# to keep train and train_clean for EDA
train_model <- train %>%
  mutate(
    # Fix target variable naming
    loan_paid_back = factor(loan_paid_back,
                           levels = c(0, 1),
                           labels = c("Not_Paid", "Paid")),
    
    # Use the EXACT SAME feature engineering from your Feature Engineering chunk
    credit_risk_tier = factor(case_when(
      credit_score <= 650 ~ "High_Risk",
      credit_score > 650 & credit_score < 700 ~ "Medium_Risk", 
      credit_score >= 700 ~ "Low_Risk"
    )),
    
    employment_stability = factor(case_when(
      employment_status %in% c("Employed", "Retired", "Self-employed") ~ "Stable",
      employment_status == "Student" ~ "Moderate", 
      employment_status == "Unemployed" ~ "Unstable"
    )),
    
    high_risk_combination = as.factor(ifelse(
      employment_status %in% c("Retired", "Student") & credit_score <= 650, 1, 0
    )),
    
    # Include the loan_risk_tier you created
    loan_risk_tier = factor(case_when(
      grade_subgrade %in% c(paste0("A", 1:5), paste0("B", 1:5)) ~ "Safe",
      grade_subgrade %in% paste0("C", 1:5) ~ "Moderate",
      TRUE ~ "Dangerous"
    ))
  ) %>%
  na.omit()

# Remove emp_payback_rate from the model for now (it's causing issues)
# Set up and run 5-fold cross-validation
set.seed(123)
ctrl <- trainControl(
  method = "cv",
  number = 5,
  summaryFunction = twoClassSummary,
  classProbs = TRUE,
  verboseIter = FALSE
)

# Model with your engineered features (without emp_payback_rate)
cv_model <- train(
  loan_paid_back ~ credit_score + annual_income + 
    debt_to_income_ratio + loan_amount + interest_rate +
    credit_risk_tier + employment_stability + high_risk_combination +
    loan_risk_tier,
  data = train_model,
  method = "glm", 
  family = "binomial",
  trControl = ctrl,
  metric = "ROC"
)

# Print CV results
print(paste("Cross-validated AUC:", round(mean(cv_model$results$ROC), 4)))

# Apply same feature engineering to test set
test_clean <- test %>%
  mutate(
    credit_risk_tier = factor(case_when(
      credit_score <= 650 ~ "High_Risk",
      credit_score > 650 & credit_score < 700 ~ "Medium_Risk", 
      credit_score >= 700 ~ "Low_Risk"
    )),
    employment_stability = factor(case_when(
      employment_status %in% c("Employed", "Retired", "Self-employed") ~ "Stable",
      employment_status == "Student" ~ "Moderate", 
      employment_status == "Unemployed" ~ "Unstable"
    )),
    high_risk_combination = as.factor(ifelse(
      employment_status %in% c("Retired", "Student") & credit_score <= 650, 1, 0
    )),
    loan_risk_tier = factor(case_when(
      grade_subgrade %in% c(paste0("A", 1:5), paste0("B", 1:5)) ~ "Safe",
      grade_subgrade %in% paste0("C", 1:5) ~ "Moderate",
      TRUE ~ "Dangerous"
    ))
  )

# Final predictions
final_predictions <- predict(cv_model, newdata = test_clean, type = "prob")$Paid

# Create submission file
submission <- data.frame(
  id = test_clean$id,
  loan_paid_back = final_predictions
)

write.csv(submission, "simple_cv_model_submission.csv", row.names = FALSE)
```



