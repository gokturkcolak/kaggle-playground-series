---
title: "Season 5 Episode 11 | Predicting Loan Payback"
author: "Göktürk Çolak"
date: "2025-11-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Upload and Preprocessing

```{r}
# libraries
library(tidyverse)

# setting up the directory
setwd("C:/Users/Göktürk/Desktop/Github/kaggle-playground-series/Season 5 Episode 11")

# uploading the files
train <- read_csv("data/train.csv")
test <- read_csv("data/test.csv")
sample_submission <- read_csv("data/sample_submission.csv")

train <- train %>% 
  mutate(loan_paid_back = as.factor(loan_paid_back)) 

levels(train$loan_paid_back)
```

# Exploratory Data Analysis

```{r}
train %>% 
  ggplot( aes(x = credit_score, fill = loan_paid_back)) +
  geom_density(alpha = 0.5) +
  labs(title = "Credit Score Distribution by Payback Status")


train %>% 
  ggplot(aes(x = employment_status, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Employment Status", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


train %>% 
  ggplot(aes(x = credit_score, fill = loan_paid_back)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~employment_status) +
  labs(title = "Credit Score Distribution by Employment Status and Payback")



# Note: Omit outliers since IQR is low (0.084) - DONE
# summary(train$debt_to_income_ratio)
Q1_dti <- quantile(train$debt_to_income_ratio, 0.25)
Q3_dti <- quantile(train$debt_to_income_ratio, 0.75)
IQR_dti <- IQR(train$debt_to_income_ratio)

lower_bound_dti <- Q1_dti - 1.5 * IQR_dti
upper_bound_dti <- Q3_dti + 1.5 * IQR_dti

# Filter out outliers
train_clean <- train %>%
  filter(debt_to_income_ratio >= lower_bound_dti & debt_to_income_ratio <= upper_bound_dti)


train_clean %>% 
  ggplot(aes(x = debt_to_income_ratio, fill = loan_paid_back)) +
  geom_density(alpha = 0.3) +
  labs(title = "Debt-to-Income Ratio by Payback Status (Outliers Removed)")


# ? Not sure, model may catch some signals
train %>% 
  ggplot(aes(x = loan_purpose, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Loan Purpose", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# A1:B5 ~ Safe
# C1:C5 ~ Moderate
# D1:F5 ~ Dangerous
train %>% 
  ggplot(aes(x = grade_subgrade, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Loan Grade/Subgrade", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# corrplot ---------------------------------------------------------------------
library(corrplot)

numerical_vars <- train %>% 
  select(annual_income, debt_to_income_ratio, credit_score, loan_amount, interest_rate, loan_paid_back) %>%
  mutate(loan_paid_back = as.numeric(as.character(loan_paid_back)))

cor_matrix <- cor(numerical_vars, use = "complete.obs")

corrplot(cor_matrix, method = "color", type = "upper")

# corrplot ends ----------------------------------------------------------------

# Interest Rate
Q1_interest <- quantile(train$interest_rate, 0.25)
Q3_interest <- quantile(train$interest_rate, 0.75)
IQR_interest <- IQR(train$interest_rate)

lower_bound_interest <- Q1_interest - 1.5 * IQR_interest
upper_bound_interest <- Q3_interest + 1.5 * IQR_interest

train_clean <- train %>%
  filter(interest_rate >= lower_bound_interest & interest_rate <= upper_bound_interest)

train_clean %>% 
  ggplot(aes(interest_rate, fill = loan_paid_back)) +
  geom_density(alpha = .3)
```

--------------------------------------------------------------------------------

EDAs tested: 
1 - loan amount X interest rate = no
2 - interest X target = no
3 - gender X target = no
4 - education X target = no
5 - annual income X target = no

--------------------------------------------------------------------------------

# Feature Engineering

```{r}
# 1. Credit Score Binning - Done
train <- train %>%
  mutate(credit_risk_tier = case_when(credit_score <= 650 ~ "High_Risk",
                                      credit_score > 650 & credit_score < 700 ~ "Medium_Risk", 
                                      credit_score >= 700 ~ "Low_Risk")
         )

# 2. Employment Stability - ?
train <- train %>%
  mutate(employment_stability = case_when(employment_status %in% c("Employed", "Retired", "Self-employed") ~ "Stable",
                                          employment_status == "Student" ~ "Moderate", 
                                          employment_status == "Unemployed" ~ "Unstable"))

# 3. High-Risk Combination - ?
train <- train %>%
  mutate(high_risk_combination = ifelse(employment_status %in% c("Retired", "Student") & credit_score <= 650, 1, 0))

# Target encoding for employment (if you have enough data) - ? (get it explained by Gemini/Deepseek)
employment_payback_rate <- train %>%
  group_by(employment_status) %>%
  summarise(emp_payback_rate = mean(as.numeric(as.character(loan_paid_back))))

train <- train %>% left_join(employment_payback_rate, by = "employment_status")


# 4. Subgrade Classification
train <- train %>%
  mutate(grade_subgrade = factor(grade_subgrade, levels = c(paste0("A", 1:5), paste0("B", 1:5),
                                                            paste0("C", 1:5), paste0("D", 1:5),
                                                            paste0("E", 1:5), paste0("F", 1:5)),
                                 ordered = TRUE),
         loan_risk_tier = case_when(grade_subgrade %in% c(paste0("A", 1:5), paste0("B", 1:5)) ~ "Safe",
                                    grade_subgrade %in% paste0("C", 1:5) ~ "Moderate",
                                    TRUE ~ "Dangerous"))

train <- train %>%
  mutate(interest_rate_risk = case_when(interest_rate < 12.5 ~ "Low_Risk",
                                        interest_rate >= 12.5 ~ "High_Risk"))
```

# Feature Plots

```{r}
# Check separation between risk tiers
ggplot(train, aes(x = credit_risk_tier, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by Credit Risk Tier", 
       y = "Proportion", x = "Credit Risk Tier") +
  scale_fill_manual(values = c("red", "green"))



# Compare original vs engineered feature
p1 <- ggplot(train, aes(x = employment_status, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Original Employment Status", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p2 <- ggplot(train, aes(x = employment_stability, fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Engineered Employment Stability", y = "Proportion")

library(patchwork)
p1 + p2  # Side-by-side comparison


# Show the power of this flag
ggplot(train, aes(x = factor(high_risk_combination), fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(title = "Payback Rate by High-Risk Combination Flag",
       x = "High Risk Combination (Unemployed + Poor Credit)",
       y = "Proportion") +
  scale_x_discrete(labels = c("No", "Yes"))


# Show continuous relationship
ggplot(train, aes(x = emp_payback_rate, fill = loan_paid_back)) +
  geom_density(alpha = 0.7) +
  labs(title = "Distribution of Employment Payback Rate by Actual Outcome",
       x = "Employment Group Payback Rate",
       y = "Density") +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red")

```

# Combined Plots

```{r}
# Create a validation grid
library(patchwork)

plot1 <- ggplot(train, aes(x = credit_risk_tier, fill = loan_paid_back)) +
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45))

plot2 <- ggplot(train, aes(x = employment_stability, fill = loan_paid_back)) +
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45))

plot3 <- ggplot(train, aes(x = factor(high_risk_combination), fill = loan_paid_back)) +
  geom_bar(position = "fill") +
  labs(x = "High Risk Flag")

plot4 <- ggplot(train, aes(x = emp_payback_rate, color = loan_paid_back)) +
  geom_density() + 
  labs(x = "Emp Payback Rate")

(plot1 + plot2) / (plot3 + plot4) +
  plot_annotation(title = "Feature Engineering Validation")
```

# Final Feature Engineering & Modelling & Submission File

```{r}
# Load libraries
library(dplyr)
library(caret)
library(xgboost)

# Apply the SAME feature engineering from above to create modeling dataset
train_model <- train %>%
  mutate(
    # Fix target variable naming
    loan_paid_back = factor(loan_paid_back,
                           levels = c(0, 1),
                           labels = c("Not_Paid", "Paid")),
    
    # Use the EXACT SAME feature engineering from your Feature Engineering chunk
    credit_risk_tier = factor(case_when(
      credit_score <= 650 ~ "High_Risk",
      credit_score > 650 & credit_score < 700 ~ "Medium_Risk", 
      credit_score >= 700 ~ "Low_Risk"
    )),
    
    employment_stability = factor(case_when(
      employment_status %in% c("Employed", "Retired", "Self-employed") ~ "Stable",
      employment_status == "Student" ~ "Moderate", 
      employment_status == "Unemployed" ~ "Unstable"
    )),
    
    high_risk_combination = as.factor(ifelse(
      employment_status %in% c("Retired", "Student") & credit_score <= 650, 1, 0
    )),
    
    # Include the loan_risk_tier you created
    loan_risk_tier = factor(case_when(
      grade_subgrade %in% c(paste0("A", 1:5), paste0("B", 1:5)) ~ "Safe",
      grade_subgrade %in% paste0("C", 1:5) ~ "Moderate",
      TRUE ~ "Dangerous"
    )),
    
    # Add interest_rate_risk
    interest_rate_risk = case_when(
      interest_rate < 12.5 ~ "Low_Risk",
      interest_rate >= 12.5 ~ "High_Risk"
    )
  ) %>%
  na.omit()

# Set up and run 5-fold cross-validation for Logistic Regression
set.seed(123)
ctrl <- trainControl(
  method = "cv",
  number = 5,
  summaryFunction = twoClassSummary,
  classProbs = TRUE,
  verboseIter = TRUE
)

# 1. Logistic Regression Model
cv_model <- train(
  loan_paid_back ~ credit_score + annual_income + 
    debt_to_income_ratio + loan_amount + interest_rate +
    credit_risk_tier + employment_stability + high_risk_combination +
    loan_risk_tier + interest_rate_risk,
  data = train_model,
  method = "glm", 
  family = "binomial",
  trControl = ctrl,
  metric = "ROC"
)

print(paste("Logistic Regression AUC:", round(mean(cv_model$results$ROC), 4)))

# 2. Proper XGBoost with early stopping and metric tracking
# Prepare data for XGBoost (convert to matrix)
train_features <- train_model %>%
  select(credit_score, annual_income, debt_to_income_ratio, loan_amount, 
         interest_rate, credit_risk_tier, employment_stability, 
         high_risk_combination, loan_risk_tier, interest_rate_risk) %>%
  model.matrix(~ . - 1, data = .)  # Convert factors to dummy variables

train_label <- as.numeric(train_model$loan_paid_back == "Paid")  # Convert to 0/1

# Create XGBoost specific data structure
dtrain <- xgb.DMatrix(data = train_features, label = train_label)

# Set parameters with early stopping
params <- list(
  objective = "binary:logistic",
  eval_metric = "auc",
  eta = 0.1,
  max_depth = 6,
  min_child_weight = 1,
  subsample = 0.8,
  colsample_bytree = 0.8
)

# Train with early stopping and watch progress
xgb_cv <- xgb.cv(
  params = params,
  data = dtrain,
  nrounds = 1000,
  nfold = 5,
  early_stopping_rounds = 50,
  verbose = TRUE,
  print_every_n = 100
)

# Train final model on full training data
final_xgb <- xgb.train(
  params = params,
  data = dtrain,
  nrounds = xgb_cv$best_iteration,
  verbose = 1
)

print(paste("Best XGBoost CV AUC:", 1 - xgb_cv$evaluation_log$test_auc_mean[xgb_cv$best_iteration]))

# Prepare test set with same feature engineering
test_clean <- test %>%
  mutate(
    credit_risk_tier = factor(case_when(
      credit_score <= 650 ~ "High_Risk",
      credit_score > 650 & credit_score < 700 ~ "Medium_Risk", 
      credit_score >= 700 ~ "Low_Risk"
    )),
    employment_stability = factor(case_when(
      employment_status %in% c("Employed", "Retired", "Self-employed") ~ "Stable",
      employment_status == "Student" ~ "Moderate", 
      employment_status == "Unemployed" ~ "Unstable"
    )),
    high_risk_combination = as.factor(ifelse(
      employment_status %in% c("Retired", "Student") & credit_score <= 650, 1, 0
    )),
    loan_risk_tier = factor(case_when(
      grade_subgrade %in% c(paste0("A", 1:5), paste0("B", 1:5)) ~ "Safe",
      grade_subgrade %in% paste0("C", 1:5) ~ "Moderate",
      TRUE ~ "Dangerous"
    )),
    interest_rate_risk = case_when(
      interest_rate < 12.5 ~ "Low_Risk",
      interest_rate >= 12.5 ~ "High_Risk"
    )
  )

# Prepare test features for XGBoost
test_features <- test_clean %>%
  select(credit_score, annual_income, debt_to_income_ratio, loan_amount, 
         interest_rate, credit_risk_tier, employment_stability, 
         high_risk_combination, loan_risk_tier, interest_rate_risk) %>%
  model.matrix(~ . - 1, data = .)

dtest <- xgb.DMatrix(data = test_features)

# Generate predictions from both models
logistic_predictions <- predict(cv_model, newdata = test_clean, type = "prob")$Paid
xgb_predictions <- predict(final_xgb, newdata = dtest)

# Create submission files
# 1. Logistic Regression
logistic_submission <- data.frame(
  id = test_clean$id,
  loan_paid_back = logistic_predictions
)
write.csv(logistic_submission, "logistic_submission.csv", row.names = FALSE)

# 2. XGBoost
xgb_submission <- data.frame(
  id = test_clean$id,
  loan_paid_back = xgb_predictions
)
write.csv(xgb_submission, "xgb_submission.csv", row.names = FALSE)

# 3. Ensemble (Average)
ensemble_predictions <- (logistic_predictions + xgb_predictions) / 2
ensemble_submission <- data.frame(
  id = test_clean$id,
  loan_paid_back = ensemble_predictions
)
write.csv(ensemble_submission, "ensemble_submission.csv", row.names = FALSE)

print("All submission files created: logistic_submission.csv, xgb_submission.csv, ensemble_submission.csv")
```



